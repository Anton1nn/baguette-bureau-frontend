<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Tableau de bord | Boulangerie SaaS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="clouds-bg">
    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='266' height='74'><ellipse cx='100' cy='42' rx='88' ry='28' fill='%23fff5e9' /><ellipse cx='160' cy='30' rx='28' ry='22' fill='%23fff5e9' opacity='.84' /><ellipse cx='200' cy='48' rx='32' ry='15' fill='%23fff5e9' opacity='.73' /></svg>" class="cloud-1" aria-hidden="true">
    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='218' height='69'><ellipse cx='90' cy='43' rx='69' ry='21' fill='%23fffaf1' /><ellipse cx='170' cy='31' rx='28' ry='15' fill='%23fffaf1' /></svg>" class="cloud-2" aria-hidden="true">
    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='211' height='62'><ellipse cx='80' cy='31' rx='61' ry='18' fill='%23fff0dc' /><ellipse cx='170' cy='19' rx='32' ry='14' fill='%23fff0dc' /></svg>" class="cloud-3" aria-hidden="true">
    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='80' height='37'><ellipse cx='41' cy='19' rx='35' ry='13' fill='%23fffefb' /></svg>" class="cloud-4" aria-hidden="true">
  </div>
  <header>
    <div class="logo-row">
      <img src="static/images/logo_bb_.png" alt="Logo Boulangerie SaaS" />
      <span style="font-size:1.2em; font-weight:800; color:#ef9100; font-family:'Quicksand','Montserrat',Arial,sans-serif;">Baguette &amp; Bureau</span>
    </div>
    <div class="client-name" id="clientName"></div>
  </header>
  <main>
    <section class="bread-panel" style="max-width:650px;width:97vw;padding-top:30px;padding-bottom:36px;">
      <h1 style="font-family:'Quicksand', 'Montserrat', Arial, sans-serif; font-size:2.05em; text-shadow:0 2px 0 #fff8e3, 0 3px 33px #c97c5d44; color:#c97c5d; letter-spacing:0.03em; margin-top:0; margin-bottom:14px;">Bienvenue sur votre tableau de bord</h1>
      <div class="status-row" id="waStatus" style="width:100%; box-sizing:border-box;">
        <span class="loader"></span>V√©rification WhatsApp...
      </div>
      <div class="table-wrap" style="margin-top:12px;background:#fff9ee;border-radius:12px;box-shadow:0 2px 22px #eddabb2a;">
        <table>
          <thead>
            <tr>
              <th style="font-family:'Montserrat',sans-serif;font-weight:700;">Commande</th>
              <th style="font-family:'Montserrat',sans-serif;font-weight:700;">Date</th>
              <th style="font-family:'Montserrat',sans-serif;font-weight:700;">Client</th>
              <th style="font-family:'Montserrat',sans-serif;font-weight:700;">Statut</th>
            </tr>
          </thead>
          <tbody id="ordersTable">
            <tr>
              <td colspan="4" class="empty-row" style="font-style:italic;opacity:.7;font-family:'Montserrat',sans-serif;">Chargement des commandes...</td>
            </tr>
          </tbody>
        </table>
      </div>
      <a href="products.html" class="cta-btn-link" style="display:block;text-align:center;margin-top:2em;">
        <button class="cta-btn" type="button">Passer une commande</button>
      </a>
    </section>
  </main>
  <footer>
    Fait avec <span class="footer-croissant" aria-hidden="true">ü•ê</span> par l'√©quipe <b>Boulangerie SaaS</b>
  </footer>
  <script>
    // --- Configuration backend
    const BASE_URL = window.location.origin.replace(/:\d+$/, ':8000');
    const getWhatsappStatusUrl = (client_id) => `${BASE_URL}/whatsapp/status/${client_id}`;
    const getOrdersUrl = `${BASE_URL}/orders/history`;
    // -- Variables utilisateur
    const jwt = localStorage.getItem('jwt_token');
    const client_id = localStorage.getItem('client_id');
    let client_name = localStorage.getItem('client_name'); // Optionnel, √† mettre au login si possible

    // -- Affichage du nom client si trouv√©
    if (client_name) {
      document.getElementById('clientName').textContent = `Client : ${client_name}`;
    } else if (client_id) {
      document.getElementById('clientName').textContent = `Client ID : ${client_id}`;
    } else {
      document.getElementById('clientName').textContent = '';
    }

    // -- Utils
    function showWaStatus(status) {
      const st = document.getElementById('waStatus');
      if (status === "authenticated") {
        st.innerHTML = '<span class="status-online">WhatsApp connect√© ‚úÖ</span>';
      } else if (status === "not_authenticated") {
        st.innerHTML = '<span class="status-offline">Non connect√© ‚ùå</span>';
      } else if (status === "loading") {
        st.innerHTML = `<span class="loader"></span>V√©rification WhatsApp...`;
      } else {
        st.innerHTML = '<span class="status-offline">Erreur connexion WhatsApp</span>';
      }
    }

    function htmlEscape(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    // ---- V√©rification WhatsApp
    async function fetchWaStatus() {
      if (!client_id) {
        showWaStatus('error');
        return;
      }
      showWaStatus('loading');
      try {
        const res = await fetch(getWhatsappStatusUrl(client_id));
        const data = await res.json();
        if (data.status === "authenticated") {
          showWaStatus("authenticated");
        } else {
          showWaStatus("not_authenticated");
        }
      } catch (e) {
        showWaStatus("error");
      }
    }

    // ---- Affichage commandes
    async function fetchOrders() {
      const tbody = document.getElementById('ordersTable');
      tbody.innerHTML = `<tr><td colspan="4" class="empty-row"><span class="loader"></span>Chargement des commandes...</td></tr>`;
      if (!jwt) {
        tbody.innerHTML = `<tr><td colspan="4" class="empty-row">Non authentifi√©. <a href="login.html">Se connecter</a></td></tr>`;
        return;
      }
      try {
        const res = await fetch(getOrdersUrl, {
          headers: { Authorization: 'Bearer ' + jwt }
        });
        if (!res.ok) throw new Error();
        const data = await res.json();
        if (!data.orders || data.orders.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4" class="empty-row">Aucune commande pour l‚Äôinstant.</td></tr>`;
          return;
        }
        tbody.innerHTML = data.orders.map(order => `
            <tr>
              <td>${htmlEscape(order.id || order.num || "Commande")}</td>
              <td>${htmlEscape(order.date || order.created_at || "-")}</td>
              <td>${htmlEscape(order.client || order.client_name || "-")}</td>
              <td>${htmlEscape(order.status || order.statut || "-")}</td>
            </tr>
          `).join('');
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="4" class="empty-row">Erreur lors du chargement des commandes.</td></tr>`;
      }
    }

    // --------- Initialisation
    document.addEventListener('DOMContentLoaded', () => {
      fetchWaStatus();
      fetchOrders();
    });
  </script>
</body>
</html>
